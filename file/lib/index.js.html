<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/index.js | createRest documentation API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/atomixinteractions/createrest" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/index.js~Maker.html">Maker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-flattenRoutes">flattenRoutes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createRest">createRest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-printRoutes">printRoutes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-resourceOptions">resourceOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ResourceController">ResourceController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RestRoutes">RestRoutes</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">
/**
 * @desc Simple object for `resource()`
 * @typedef {object} ResourceController
 * @property {function} [beforeEach] Called before each request
 * @property {function} [afterEach] Called after each request
 * @property {function} [read] Handle GET /name
 * @property {function} [create] Handle POST /name
 * @property {function} [update] Handle PUT /name
 * @property {function} [destroy] handle DELETE /name
 * @example
 * const DemoController = {
 *   beforeEach(req, res, next) {
 *     // any checks here
 *     next()
 *   },
 *   create(req, res, next) {
 *     context.makeDemo.create(req.params)
 *     res.json({ complete: true })
 *     next()
 *   },
 *   afterEach(req, res, next) {
 *     // close your resources here
 *     context.db.close()
 *   }
 * }
 */

/**
 * @desc Routes object
 * @typedef {object} RestRoutes Foo bar
 */

/**
 * @class Maker
 * @protected
 */
export class Maker {
  /**
   * @ignore
   */
  constructor() {
    /**
     * @ignore
     */
    this.ctx = {
      before: [],
      after: [],
      scoped: {},
      local: {},
    }
  }

  /**
   * @ignore
   * Build routes ast
   */
  build() {
    const scoped = {}
    Object.keys(this.ctx.scoped).forEach(name =&gt; {
      scoped[name] = this.ctx.scoped[name].build()
    })
    return Object.assign({}, this.ctx, { scoped })
  }

  /**
   * Add middlewares before request handler to current scope
   * @param {...function[]} list List of the middlewares
   *
   * @example
   * createRest(r =&gt; {
   *   r.before(() =&gt; console.log(1))
   *   r.before(() =&gt; console.log(2), () =&gt; console.log(3))
   * })
   */
  before(...list) {
    this.ctx.before = this.ctx.before.concat(list.filter(ln =&gt; !!ln))
  }

  /**
   * Add middlewares after request handler to current scope
   * @param {...function[]} list List of the middlewares
   * @example
   * createRest(r =&gt; {
   *   r.after(() =&gt; console.log(3))
   *   r.after(() =&gt; console.log(2), () =&gt; console.log(1))
   * })
   */
  after(...list) {
    this.ctx.after = this.ctx.after.concat(list.filter(ln =&gt; !!ln))
  }

  /**
   * Add scoped address, before/after handlers and simple handlers.
   * Before/After handlers is inherits from parent scope.
   * Scopes don&apos;t merging. Use only one scope for unique path.
   *
   * @param {string} name Name of the scope
   * @param {function(r: Maker): undefined} creator
   * @throws {Error}
   * @throws {TypeError}
   * @example
   * createRest(r =&gt; {
   *   r.before(() =&gt; console.log(1))
   *   r.after(() =&gt; console.log(4))
   *
   *   r.scope(&apos;foo&apos;, r =&gt; {
   *     r.before(() =&gt; console.log(2))
   *     r.after(() =&gt; console.log(5))
   *
   *     r.get(&apos;bar&apos;, () =&gt; console.log(3))
   *   })
   * })
   */
  scope(name, creator) {
    if (typeof name !== &apos;string&apos;) {
      throw new TypeError(&apos;Name of the scope should be string!&apos;)
    }
    if (name.length === 0 || name.indexOf(&apos;/&apos;) !== -1) {
      throw new Error(&apos;Name of the scope should be a word&apos;)
    }

    const scopedCtx = new Maker()
    creator(scopedCtx)
    this.ctx.scoped[name] = scopedCtx
  }

  /**
   * Add HTTP method listeners to local
   *
   * @ignore
   * @param {string} method
   * @param {function[]} listeners
   */
  local(method, listeners) {
    // if listeners for that methods exists, simple merge
    if (this.ctx.local[method]) {
      this.ctx.local[method] = this.ctx.local[method].concat(listeners)
    }
    else {
      this.ctx.local[method] = listeners
    }
  }

  /**
   * Handle method creator
   *
   * @ignore
   * @param {string} name
   * @param {string} method
   * @param {function[]} listeners
   */
  method(method, _listeners) {
    let name = &apos;&apos;
    let listeners = _listeners
    if (typeof listeners[0] === &apos;string&apos;) {
      name = listeners.splice(0, 1)[0]
    }
    name = name.replace(/^\//gm, &apos;&apos;)

    if (name.indexOf(&apos;/&apos;) !== -1) {
      throw new Error(&apos;Path should not be deep&apos;)
    }
    if (listeners.length === 0) {
      throw new TypeError(&apos;Maybe you forget to add listener?&apos;)
    }

    listeners = listeners.filter(e =&gt; typeof e === &apos;function&apos;)

    // if added undefined listeners
    if (listeners.length === 0) return

    if (name !== &apos;&apos;) {
      let scoped = this.ctx.scoped[name]
      if (!scoped) {
        scoped = new Maker()
        this.ctx.scoped[name] = scoped
      }

      scoped.local(method, listeners)
    }
    else {
      this.local(method, listeners)
    }
  }

  /**
   * Handle POST HTTP method with single or many handlers
   * @param {string} [name] Route path. Default is current scope
   * @param {...function} handlers List of http-handlers
   * @throws {Error} Path should not be deep
   * @throws {TypeError} Maybe you forget to add listener?
   * @example
   * createRest(r =&gt; {
   *   r.post(&apos;name&apos;, () =&gt; console.log(&apos;Handled post /name request&apos;))
   *   r.post(() =&gt; console.log(&apos;Handled post / request&apos;))
   *   r.post(&apos;create&apos;,
   *     (req, res, next) =&gt; next(),
   *     authorize(&apos;user&apos;),
   *     () =&gt; console.log(&apos;Handled post /create with middlewares&apos;)
   *   )
   * })
   */
  post(name, ...handlers) {
    this.method(&apos;POST&apos;, [name, ...handlers])
  }

  /**
   * Handle GET HTTP method with single or many handlers
   * @param {string} [name] Route path. Default is current scope
   * @param {...function} handlers List of http-handlers
   * @throws {Error} Path should not be deep
   * @throws {TypeError} Maybe you forget to add listener?
   * @example
   * createRest(r =&gt; {
   *   r.get(&apos;name&apos;, () =&gt; console.log(&apos;Handled get /name request&apos;))
   *   r.get(() =&gt; console.log(&apos;Handled get / request&apos;))
   *   r.get(&apos;create&apos;,
   *     (req, res, next) =&gt; next(),
   *     authorize(&apos;user&apos;),
   *     () =&gt; console.log(&apos;Handled get /create with middlewares&apos;)
   *   )
   * })
   */
  get(name, ...handlers) {
    this.method(&apos;GET&apos;, [name, ...handlers])
  }

  /**
   * Handle PUT HTTP method with single or many handlers
   * @param {string} [name] Route path. Default is current scope
   * @param {...function} handlers List of http-handlers
   * @throws {Error} Path should not be deep
   * @throws {TypeError} Maybe you forget to add listener?
   * @example
   * createRest(r =&gt; {
   *   r.put(&apos;name&apos;, () =&gt; console.log(&apos;Handled put /name request&apos;))
   *   r.put(() =&gt; console.log(&apos;Handled put / request&apos;))
   *   r.put(&apos;create&apos;,
   *     (req, res, next) =&gt; next(),
   *     authorize(&apos;user&apos;),
   *     () =&gt; console.log(&apos;Handled put /create with middlewares&apos;)
   *   )
   * })
   */
  put(name, ...handlers) {
    this.method(&apos;PUT&apos;, [name, ...handlers])
  }

  /**
   * Handle DELETE HTTP method with single or many handlers
   * @param {string} [name] Route path. Default is current scope
   * @param {...function} handlers List of http-handlers
   * @throws {Error} Path should not be deep
   * @throws {TypeError} Maybe you forget to add listener?
   * @example
   * createRest(r =&gt; {
   *   r.delete(&apos;name&apos;, () =&gt; console.log(&apos;Handled delete /name request&apos;))
   *   r.delete(() =&gt; console.log(&apos;Handled delete / request&apos;))
   *   r.delete(&apos;create&apos;,
   *     (req, res, next) =&gt; next(),
   *     authorize(&apos;user&apos;),
   *     () =&gt; console.log(&apos;Handled delete /create with middlewares&apos;)
   *   )
   * })
   */
  delete(name, ...handlers) {
    this.method(&apos;DELETE&apos;, [name, ...handlers])
  }

  /**
   * Handle PATCH HTTP method with single or many handlers
   * @param {string} [name] Route path. Default is current scope
   * @param {...function} handlers List of http-handlers
   * @throws {Error} Path should not be deep
   * @throws {TypeError} Maybe you forget to add listener?
   * @example
   * createRest(r =&gt; {
   *   r.patch(&apos;name&apos;, () =&gt; console.log(&apos;Handled patch /name request&apos;))
   *   r.patch(() =&gt; console.log(&apos;Handled patch / request&apos;))
   *   r.patch(&apos;create&apos;,
   *     (req, res, next) =&gt; next(),
   *     authorize(&apos;user&apos;),
   *     () =&gt; console.log(&apos;Handled patch /create with middlewares&apos;)
   *   )
   * })
   */
  patch(name, ...handlers) {
    this.method(&apos;PATCH&apos;, [name, ...handlers])
  }

  /**
   * @desc Configure your `resource(&apos;name&apos;, controller, options)`
   * @typedef {object} resourceOptions
   * @property {string[]} [only] Keep only that handlers: `[read, create, update, destroy]`
   * @property {string[]} [except] Keep all except that handlers
   * @property {object} [methodNames] Change method names
   *
   * @example &lt;caption&gt;Usage with `only`&lt;/caption&gt;
   * createRest(r =&gt; {
   *   r.resource(&apos;foo&apos;, FooController, { only: [&apos;read&apos;] })
   * })
   *
   * @example &lt;caption&gt;Usage with `except`&lt;/caption&gt;
   * createRest(r =&gt; {
   *   r.resource(&apos;bar&apos;, BarController, { except: [&apos;destroy&apos;, &apos;update&apos;] })
   * })
   *
   * @example &lt;caption&gt;Method names&lt;/caption&gt;
   * const Controller = {
   *   createDemo() {},
   *   updateMe() {},
   *   justExample() {},
   *   youDontNeedThis() {},
   * }
   * createRest(r =&gt; {
   *   r.resource(&apos;demo&apos;, Controller, { methodNames: {
   *     read: &apos;justExample&apos;, create: &apos;createDemo&apos;, update: &apos;updateMe&apos;, destroy: &apos;youDontNeedThis&apos;,
   *   }})
   * })
   */

  /**
   * Create CRUD methods for single resource.
   *
   * Resources not merging. Use only one resource for path.
   * @param {string} name Name of the resource. Create route path from
   * @param {ResourceController} controller Object with methods
   * @param {resourceOptions} [options={}] Options object
   * @example
   * const Controller = {
   *   read() {},
   *   create() {},
   *   update() {},
   *   destroy() {},
   *   beforeEach() {},
   *   afterEach() {},
   * }
   * const SecondCtrl = {
   *   read() {},
   *   update() {},
   * }
   * const routes = createRest(r =&gt; {
   *   r.resource(&apos;example&apos;, Controller)
   *   r.resource(&apos;demo&apos;, Controller, { only: [&apos;create&apos;, &apos;read&apos;] })
   *   r.resource(&apos;single&apos;, Controller, { except: [&apos;destroy&apos;, &apos;create&apos;] })
   * })
   * printRoutes(routes, true)
   */
  resource(name, controller, options = {}) {
    if (!name || name.length === 0) {
      throw new Error(&apos;Resource should be named&apos;)
    }

    if (typeof controller === &apos;undefined&apos;) {
      return
    }

    const methods = {
      read: &apos;get&apos;,
      create: &apos;post&apos;,
      update: &apos;put&apos;,
      destroy: &apos;delete&apos;,
    }
    const methodsList = Object.keys(methods)

    const resolveMethodName = (handler, currentController) =&gt; options.methodNames &amp;&amp; options.methodNames[handler]
      ? currentController[options.methodNames[handler]]
      : currentController[handler]

    /**
     * @var {Array&lt;[string, string]&gt;} usedList [[handlerName, httpMethod], ...]
     */
    let usedList = []

    if (Array.isArray(options.only)) {
      usedList = options.only
    }
    else if (Array.isArray(options.except)) {
      usedList = methodsList
        .filter(handlerName =&gt; !options.except.includes(handlerName))
    }
    else {
      usedList = methodsList
    }

    this.scope(name, r =&gt; {
      r.before(controller.beforeEach)
      r.after(controller.afterEach)

      usedList
        .filter(handler =&gt; methodsList.includes(handler))
        .map(handler =&gt; [handler, methods[handler]])
        .forEach(([handler, httpMethod]) =&gt; {
          r[httpMethod](resolveMethodName(handler, controller))
        })
    })
  }
}

/**
 * Create routes by sync callback
 * @param {function(r: Maker): null} creator Callback
 * @return {RestRoutes} Routes object
 */
export function createRest(creator) {
  if (typeof creator !== &apos;function&apos;) {
    throw new TypeError(&apos;Creator should be a function&apos;)
  }

  const ctx = new Maker(&apos;&apos;)
  creator(ctx)
  return ctx.build()
}

export { flattenRoutes } from &apos;./flatten&apos;
export { printRoutes } from &apos;./printer&apos;

</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
